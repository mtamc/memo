<!doctype html>
<html lang="en" id="top">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>

    <!-- CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.10.1/bootstrap-table.min.css">
    <link rel="icon" href="/img/favicon.ico" type="image/x-icon"/>
    <link rel="stylesheet" href="/css/main.css">
    <style>
        {% include "css/main.css" %}
    </style>

    <!-- JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.5/purify.min.js" integrity="sha512-GaomFB92Lot7wDqZgVgLMJwQhuVUEcPHP99xmWSVE4Kq54t1jDyH7mdKDsmN8jOMSjiQq8pf7Et+OM4ml/PVMA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
    <script type="text/javascript" src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/ramda/0.25.0/ramda.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.24.0/axios.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/bootstrap-table/1.12.1/bootstrap-table.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.2/marked.min.js" integrity="sha512-hzyXu3u+VDu/7vpPjRKFp9w33Idx7pWWNazPm+aCMRu26yZXFCby1gn1JxevVv3LDwnSbyKrvLo3JNdi4Qx1ww==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script type="text/javascript"
       src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
    </script>

    {# macro to include JS with its own const variable scope
       to not have `const` assignments pollute projectwide scope #}
    {% macro js(path) %}
      (() => {
        {% include path %}
      })();
    {% endmacro %}

    {# Include *all* your JS files here.
      The order matters, files above can't use
      global variables set in files under.
    #}
    {% set scripts %}
      {{ js("js/old_main.js") }}
      {{ js("js/packages/neverthrow.js") }}
      {{ js("js/utils/general.js") }}
      {{ js("js/utils/nullable.js") }}
      {{ js("js/utils/conversions.js") }}
      {{ js("js/utils/http.js") }}
      {{ js("js/utils/netlify.js") }}
      {{ js("js/utils/columns.js") }}
      {{ js("js/utils/tables.js") }}
      {{ js("js/components/index.js") }}
      {{ js("js/components/common.js") }}
      {{ js("js/components/with_remote_data.js") }}
      {{ js("js/components/ui/button.js") }}
      {{ js("js/components/ui/menu.js") }}
      {{ js("js/components/ui/input_with_action.js") }}
      {{ js("js/components/ui/notification.js") }}
      {{ js("js/components/ui/base.js") }}
      {{ js("js/components/ui/modal.js") }}
      {{ js("js/components/ui/tabbed.js") }}
      {{ js("js/components/home/username_setter.js") }}
      {{ js("js/components/profile/profile_lists.js") }}
      {{ js("js/components/profile/profile_stats.js") }}
      {{ js("js/components/profile/biography.js") }}
      {{ js("js/components/profile/index.js") }}
      {{ js("js/components/home/index.js") }}
      {{ js("js/components/list/add_edit_entry/buttons.js") }}
      {{ js("js/components/list/add_edit_entry/external_fields.js") }}
      {{ js("js/components/list/add_edit_entry/personal_fields.js") }}
      {{ js("js/components/list/add_edit_entry/cover_column.js") }}
      {{ js("js/components/list/add_edit_entry/entry_form.js") }}
      {{ js("js/components/list/add_edit_entry/search_results.js") }}
      {{ js("js/components/list/add_edit_entry/add_entry_link.js") }}
      {{ js("js/components/list/list.js") }}
      {{ js("js/components/list/index.js") }}
      {{ js("js/components/router.js") }}
    {% endset %}
    <script>
      {{ scripts | safe }}
    </script>
  </head>
  <body>
    <div id="site"></div>
    <script>
      // A function that refreshes the token at its expiration time, infinitely
      const refreshToken = (force) => {
        // If the token in the local storage is newer than the one
        // on the current tab, then use the one in the local storage
        // (This happens when you're on multiple memo tabs at once)
        const localStorageToken = (() => {
          try {
            return JSON.parse(localStorage.getItem('gotrue.user')).token
          } catch {
            return undefined
          }
        })()

        if (localStorageToken?.expires_at > netlifyIdentity.currentUser()?.token?.expires_at) {
          netlifyIdentity.currentUser().token = localStorageToken
        }

        if (
          netlifyIdentity.currentUser()?.token?.expires_at &&
          netlifyIdentity.currentUser()?.token?.expires_at < Date.now()
        ) {
          console.log('Refreshing')
          return netlifyIdentity.currentUser()?.jwt?.(true)
        } else {
          console.log('not refreshing')
        }
      }

      const refreshTokenWhenDue = async () => {
        console.log('checking if needing to refresh token')
        await refreshToken()
        console.log(netlifyIdentity.currentUser()?.token)
        console.log(new Date(netlifyIdentity.currentUser()?.token?.expires_at))
        const expireTime = netlifyIdentity.currentUser()?.token?.expires_at
        const refreshIn = expireTime ? (expireTime - Date.now()) : 600000
        const one_min = 60000
        window.setTimeout(refreshTokenWhenDue, refreshIn - one_min)
      }

      ;['init', 'logout'].forEach((evt) => netlifyIdentity.on(evt, refreshToken))

      // The 0 timeout is necessary to detect netlify auth token
      window.setTimeout(async () => {
        await refreshTokenWhenDue()

        // Include the router
        Components.setContent('#site', Components.Router())
      }, 0)
    </script>
  </body>
</html>



